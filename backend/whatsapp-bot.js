const axios = require('axios');
require('dotenv').config();

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è WhatsApp Business API
const WHATSAPP_TOKEN = process.env.WHATSAPP_TOKEN;
const WHATSAPP_PHONE_ID = process.env.WHATSAPP_PHONE_ID;
const WHATSAPP_API_URL = `https://graph.facebook.com/v17.0/${WHATSAPP_PHONE_ID}/messages`;

// –°–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const userStates = new Map();

// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —á–∞—Ç—É –Ω–∞ —Å–∞–π—Ç–µ)
const quickQuestions = {
  '–í–∏–¥–µ–æ-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è ‚Äî –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è': {
    answer: `*–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ:* 
*–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:*  
–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ —Å–≤–æ–∏—Ö –≥–æ—Å—Ç–µ–π —Ñ–µ–µ—Ä–∏—á–Ω–æ –∏ —Å–æ–∑–¥–∞–π—Ç–µ WOW-—ç—Ñ—Ñ–µ–∫—Ç –µ—â–µ –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ!

–ù–∞—à–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –≤–∏–¥–µ–æ-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è —É–¥–∏–≤—è—Ç –∏ –ø—Ä–æ–∏–∑–≤–µ–¥—É—Ç WOW
‚Äì —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ –≤–∞—à–∏—Ö –≥–æ—Å—Ç–µ–π. –û–Ω–∏ –∑–∞–ø–æ–º–Ω—è—Ç –≤–∞—à—É —Å–≤–∞–¥—å–±—É –µ—â–µ —Å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –∏ —Ç–æ—á–Ω–æ–∑–∞—Ö–æ—Ç—è—Ç –Ω–∞ –Ω–µ–µ –ø—Ä–∏–π—Ç–∏.

–í–æ–∑–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ, –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –¥–ª—è –≤—Å–µ—Ö,–±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏—è, –∫–∞–∫ –≤ —à–∞–±–ª–æ–Ω–µ. –ê –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∏–º–µ–Ω–Ω–æ–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ
–≥–æ—Å—Ç—è –æ—Ç–¥–µ–ª—å–Ω–æ.`,
    quickActions: ['–ó–∞–∫–∞–∑–∞—Ç—å', '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è']
  },
  '–í–∏–¥–µ–æ-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è ‚Äî —Ü–µ–Ω—ã –∏ —Å—Ä–æ–∫–∏': {
    answer: `*–°—Ç–æ–∏–º–æ—Å—Ç—å –∏ —Å—Ä–æ–∫–∏:* 
*–ù–µ–∏–º–µ–Ω–Ω–æ–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ:* 
–ó–∞–º–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ –±–µ–∑ –∏–º–µ–Ω–∏ ‚Äì 3000 —Ä./ —Å—Ä–æ–∫ ‚Äì1 –¥–µ–Ω—å
 *–ò–º–µ–Ω–Ω–æ–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ:*  
–° –æ–±—Ä–∞—â–µ–Ω–∏–µ–º –∏ —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–∞–∂–¥–æ–≥–æ –∏–º–µ–Ω–∏ –≤–Ω–∞—á–∞–ª–µ: 
–¥–æ 25 –∏–º–µ–Ω ‚Äì 4000 —Ä, 
–¥–æ 50 –∏–º–µ–Ω ‚Äì 5000 —Ä, 
 51-100 –∏–º–µ–Ω ‚Äì 7000 —Ä 
–°—Ä–æ–∫ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è 2-4 –¥–Ω—è, –≤–æ–∑–º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–µ–µ –ø–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏.`,
    quickActions: ['–ó–∞–∫–∞–∑–∞—Ç—å', '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è']
  },
  '–ú–æ–∂–Ω–æ –ª–∏ –∑–∞–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ?': {
    answer: `–û–ø–∏—à–∏—Ç–µ –∫–∞–∫ –≤–∏–¥–∏—Ç–µ –∏ –º—ã —Å–∫–∞–∂–µ–º –≤–æ–∑–º–æ–∂–Ω–æ –ª–∏ —ç—Ç–æ.`,
    quickActions: ['–ó–∞–∫–∞–∑–∞—Ç—å', '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è']
  },
  '–°–≤–∞–¥–µ–±–Ω–∞—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è ‚Äî –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è': {
    answer: `*–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:* 

1. –°–Ω–∞—á–∞–ª–∞ –¥–æ –∑–∞–∫–∞–∑–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å—Å—è —Å —ç–∫—Ä–∞–Ω–æ–º, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–∏—Ç–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏. –î–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–¥–æ–π–¥—É—Ç –Ω–µ –≤—Å–µ —ç–∫—Ä–∞–Ω—ã, –∞ —Ç–æ–ª—å–∫–æ —Å
–ø—Ä–æ–ø–æ—Ä—Ü–∏—è–º–∏ 16:9 –∏ 16:10. –£—Ç–æ—á–Ω–∏—Ç–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ —É –≤–ª–∞–¥–µ–ª—å—Ü–∞ —ç–∫—Ä–∞–Ω–∞, –∞ —Ç–∞–∫–∂–µ –µ–≥–æ—Ä–∞–∑–º–µ—Ä, –∏ —Å–æ–æ–±—â–∏—Ç–µ –Ω–∞–º –ø–µ—Ä–µ–¥ –∑–∞–∫–∞–∑–æ–º. –ß—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–∞–∫ –ø—Ä–∏–º–µ—Ä–Ω–æ –±—É–¥–µ—Ç
–≤—ã–≥–ª—è–¥–µ—Ç—å –≤–∞—à–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ —ç—Ç–æ–º —ç–∫—Ä–∞–Ω–µ ‚Äì –º–æ–∂–µ—Ç–µ —Å–∫–∞—á–∞—Ç—å –Ω–∞—à –æ–±—Ä–∞–∑–µ—Ü –∏–ø–æ–ø—Ä–æ—Å–∏—Ç—å –µ–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –Ω—ë–º. 

2. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ñ–æ—Ç–æ –∏ —Ä–∞–∑–≤–æ—Ä–æ—Ç–æ–≤ –∞–ª—å–±–æ–º–∞. –í–Ω–∞—à–µ–º –≤–∏–¥–µ–æ-–æ–±—Ä–∞–∑—Ü–µ 16 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∏ 4 —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞. –í–æ–∑–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤
–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–∑–≤–æ—Ä–æ—Ç—ã (–∫–∞–∂–¥—ã–π —Ä–∞–∑–≤–æ—Ä–æ—Ç ‚Äì 4 —Ñ–æ—Ç–æ). –¶–µ–Ω–∞ –∫–∞–∂–¥–æ–≥–æ–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞ + 500 - 1000 —Ä—É–±. –¢–∞–∫–∂–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç
–æ–±—ä–µ–º–∞ —Ç–µ–∫—Å—Ç–∞ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ —Ñ–æ—Ç–æ. –í —à–∞–±–ª–æ–Ω–µ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –∫ —Ñ–æ—Ç–æ –Ω–µ –±–æ–ª—å—à–µ 300—Å–∏–º–≤–æ–ª–æ–≤. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ—Å—Ç–∞–≤–ª—è—Ç—å —Ç–∞–∫–∂–µ, –Ω–µ –¥–µ–ª–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∫ –æ–¥–Ω–æ–º—É —Ñ–æ—Ç–æ –±–æ–ª—å—à–µ.
–≠—Ç–æ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –∑–∞—Ç—è–Ω—É—Ç–æ –∏ –∑–∞–Ω—É–¥–Ω–æ.. –¢–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω–æ–µ. –ß—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ(–Ω–∞–ø—Ä–∏–º–µ—Ä –±–∏–æ–≥—Ä–∞—Ñ–∏—é –º–∞–º—ã) –±–æ–ª—å—à–µ - –ª—É—á—à–µ –¥–æ–±–∞–≤–ª—è—Ç—å —Ñ–æ—Ç–æ –∏ —Ä–∞–∑–≤–æ—Ä–æ—Ç—ã.. –ë—É–¥–µ—Ç
–≤—ã–≥–ª—è–¥–µ—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ! 
3. –í —à–∞–±–ª–æ–Ω–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –≤—Å–µ —Ñ–æ—Ç–æ ¬´–æ–∂–∏–≤–ª–µ–Ω—ã¬ª. –ú–æ–∂–Ω–æ –∑–∞–∫–∞–∑–∞—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é –∏–±–µ–∑ –æ–∂–∏–≤–ª–µ–Ω–∏—è. –û–∂–∏–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–∏—Ç + 2000 (16 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π). –ò –¥–æ–±–∞–≤–ª—è–µ—Ç –∫ —Å—Ä–æ–∫—É
–∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è 1-2 –¥–Ω—è. 
4. –ü–æ–∫–∞ –º—É–∑—ã–∫–∞–ª—å–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ —Ç–æ–∂–µ –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º–≤–∞—Ä–∏–∞–Ω—Ç–µ. –í –¥–∞–ª—å–Ω–µ–π—à–µ–º –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∏ –¥—Ä—É–≥–∏–µ –∞—É–¥–∏–æ-–ø–æ–¥–ª–æ–∂–∫–∏ –Ω–∞ –≤—ã–±–æ—Ä. 
5. –ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ—Å—å —Å —ç–∫—Ä–∞–Ω–æ–º, –¥–ª—è –∑–∞–∫–∞–∑–∞ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É
¬´–∑–∞–∫–∞–∑–∞—Ç—å¬ª, –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—É –≤ —Ä–∞–∑–º–µ—Ä–µ 30% (–≤ —Å–ª—É—á–∞–µ –æ—Ç–∫–∞–∑–∞ –æ—Ç –∑–∞–∫–∞–∑–∞–ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è). –ü–æ—Å–ª–µ —á–µ–≥–æ –≤–∞–º –±—É–¥–µ—Ç –≤—ã—Å–ª–∞–Ω–∞ —Ñ–æ—Ä–º–∞ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
—Ñ–æ—Ç–æ –∏ —Ç–µ–∫—Å—Ç–∞. –û—á–µ–Ω—å —Ç—â–∞—Ç–µ–ª—å–Ω–æ –ø–æ–¥–æ–π–¥–∏—Ç–µ –∫ –ø–æ–¥–±–æ—Ä—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π. –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à–∏–ª—é–±–∏–º—ã–µ —Ñ–æ—Ç–æ –∏–∑ –≤–∞—à–µ–≥–æ –¥–µ—Ç—Å—Ç–≤–∞, —à–∫–æ–ª—å–Ω—ã—Ö –ª–µ—Ç, —Å—Ç—É–¥–µ–Ω—á–µ—Å—Ç–≤–∞ –∏ –∫–æ–Ω–µ—á–Ω–æ –∂–µ –≤–∞—à–∏
–ª—É—á—à–∏–µ —Å–æ–≤–º–µ—Å—Ç–Ω—ã–µ —Ñ–æ—Ç–æ. –ø–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –º—ã –≤—ã—à–ª–µ–º –≤–∞–º —Ñ–æ—Ä–º—É –¥–ª—è–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ –∏ –æ–ø–∏—Å–∞–Ω–∏—è. –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç—É–¥–∞ –≤—Å–µ —Ñ–æ—Ç–æ –∏ —Ç–µ–∫—Å—Ç. –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è
–º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –º—ã –ø—Ä–∏—Å—Ç—É–ø–∞–µ–º –∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤—É. –ü–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –º—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –≤–∞–º–≤–∏–¥–µ–æ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ. –î–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ 1 –ø—Ä–∞–≤–∫–∞ –≤ —Ç–µ–∫—Å—Ç–µ. –¢–∞–∫ —á—Ç–æ —Ñ–æ—Ç–æ
–ø–æ–¥–±–∏—Ä–∞–π—Ç–µ –æ—á–µ–Ω—å –æ–±–¥—É–º–∞–Ω–Ω–æ. –ü–æ—Å–ª–µ –ø—Ä–∞–≤–∫–∏ –∏ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –≤–∞—à–µ–π–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –≤–∞–º –Ω—É–∂–Ω–æ –¥–æ–ø–ª–∞—Ç–∏—Ç—å 70 % —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ –º—ã –ø—Ä–∏—à–ª–µ–º –≤–∞–º –≤–∞—à—É —Å–≤–∞–¥–µ–±–Ω—É—é
–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é –Ω–∞ –ø–æ—á—Ç—É.`,
    quickActions: ['–ó–∞–∫–∞–∑–∞—Ç—å', '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è']
  },
  '–°–≤–∞–¥–µ–±–Ω–∞—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è ‚Äî —Ü–µ–Ω—ã –∏ —Å—Ä–æ–∫–∏': {
    answer: `*–°—Ç–æ–∏–º–æ—Å—Ç—å –∏ —Å—Ä–æ–∫–∏:* 
*–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –±–µ–∑ –æ–∂–∏–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ* (—Ñ–æ—Ç–æ –±–µ–∑ –¥–≤–∏–∂–µ–Ω–∏—è) –∏  –æ–ø–∏—Å–∞–Ω–∏–µ–º –∫ –∫–∞–∂–¥–æ–º—É —Ñ–æ—Ç–æ –Ω–∞ 300 —Å–∏–º–≤–æ–ª–æ–≤ (–∫–∞–∫–≤ —à–∞–±–ª–æ–Ω–µ):
4 —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞ (16 —Ñ–æ—Ç–æ, 6:23 –º–∏–Ω) ‚Äì 10000—Ä / —Å—Ä–æ–∫ 3-4 –¥–Ω—è
5 —Ä–∞–∑–≤–æ—Ä–æ—Ç–æ–≤ (20 —Ñ–æ—Ç–æ, 8 –º–∏–Ω) ‚Äì 10500/—Å—Ä–æ–∫ 3-4  –¥–Ω—è 
6 —Ä–∞–∑–≤–æ—Ä–æ—Ç–æ–≤ (24 —Ñ–æ—Ç–æ, 10 –º–∏–Ω) ‚Äì 11000 / —Å—Ä–æ–∫ 4-5 –¥–Ω–µ–π 
7 —Ä–∞–∑–≤–æ—Ä–æ—Ç–æ–≤ (28 —Ñ–æ—Ç–æ, 12 –º–∏–Ω) ‚Äì 11500 / —Å—Ä–æ–∫ 4-5 –¥–Ω–µ–π
*–¶–µ–Ω—ã —Å –æ–∂–∏–≤–ª–µ–Ω–∏–µ–º —Ñ–æ—Ç–æ* –∏ —Ç–µ–∫—Å—Ç–æ–º –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –∫ –∫–∞–∂–¥–æ–º—É —Ñ–æ—Ç–æ 300
—Å–∏–º–≤–æ–ª–æ–≤ (–∫–∞–∫ —à–∞–±–ª–æ–Ω):
 4 —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞ (16 —Ñ–æ—Ç–æ,6:23 –º–∏–Ω) ‚Äì 12000—Ä /—Å—Ä–æ–∫ 4-5 –¥–Ω–µ–π
5 —Ä–∞–∑–≤–æ—Ä–æ—Ç–æ–≤ (20 —Ñ–æ—Ç–æ, 8 –º–∏–Ω) ‚Äì 1300/—Å—Ä–æ–∫ 4-5  –¥–Ω–µ–π 
6 —Ä–∞–∑–≤–æ—Ä–æ—Ç–æ–≤ (24 —Ñ–æ—Ç–æ, 10 –º–∏–Ω) ‚Äì 13500 / —Å—Ä–æ–∫ 5-6 –¥–Ω–µ–π 
7 —Ä–∞–∑–≤–æ—Ä–æ—Ç–æ–≤ (28 —Ñ–æ—Ç–æ, 12 –º–∏–Ω) ‚Äì 14000 / —Å—Ä–æ–∫ 5-6 –¥–Ω–µ–π
–ó–∞ –∫–∞–∂–¥—ã–µ 300+ —Å–∏–º–≤–æ–ª–æ–≤ –∫ —Ç–µ–∫—Å—Ç—É –¥–ª—è —Ñ–æ—Ç–æ - 200—Ä (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:
–æ—Å—Ç–∞–≤–ª—è—Ç—å —Ç–µ–∫—Å—Ç –Ω–∞ 300 —Å–∏–º–≤–æ–ª–æ–≤ –ø–æ–¥ –∫–∞–∂–¥–æ–µ —Ñ–æ—Ç–æ, –∏–Ω–∞—á–µ –±—É–¥–µ—Ç —Å–º–æ—Ç—Ä–µ—Ç—å—Å—è–∑–∞–Ω—É–¥–Ω–æ. –ï—Å–ª–∏ —Ö–æ—á–µ—Ç—Å—è –±–æ–ª—å—à–µ –æ–ø–∏—Å–∞–Ω–∏—è ‚Äî –¥–æ–±–∞–≤–ª—è–π—Ç–µ –ª—É—á—à–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏ —Ä–∞–∑–≤–æ—Ä–æ—Ç—ã,
–±—É–¥–µ—Ç —Å–º–æ—Ç—Ä–µ—Ç—å—Å—è –Ω–∞–º–Ω–æ–≥–æ –ª—É—á—à–µ)
–°—Ä–æ–∫–∏ –º–æ–≥—É—Ç –≤–∞—Ä—å–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ –∏—Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã. –£–≤–µ–ª–∏—á–∏–≤–∞—Ç—å—Å—è  –ø–æ
—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—é —Å –∑–∞–∫–∞–∑—á–∏–∫–æ–º.`,
    quickActions: ['–ó–∞–∫–∞–∑–∞—Ç—å', '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è']
  },
  '–ú–æ–∂–Ω–æ –ª–∏ –∑–∞–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—É—é –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é?': {
    answer: `–í –ø—Ä–∏–Ω—Ü–∏–ø–µ –º–æ–∂–Ω–æ. –û–ø–∏—à–∏—Ç–µ –∫–∞–∫ –≤—ã –µ–µ –≤–∏–¥–∏—Ç–µ. –ò –º—ã —Å–∫–∞–∂–µ–º —Å–º–æ–∂–µ–º –ª–∏ –º—ã —ç—Ç–æ.`,
    quickActions: ['–ó–∞–∫–∞–∑–∞—Ç—å', '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è']
  }
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
async function sendTextMessage(to, text) {
  try {
    const response = await axios.post(WHATSAPP_API_URL, {
      messaging_product: 'whatsapp',
      to: to,
      type: 'text',
      text: { body: text }
    }, {
      headers: {
        'Authorization': `Bearer ${WHATSAPP_TOKEN}`,
        'Content-Type': 'application/json'
      }
    });
    return response.data;
  } catch (error) {
    console.error('Error sending WhatsApp message:', error.response?.data || error.message);
    throw error;
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
async function sendInteractiveMessage(to, body, buttons) {
  try {
    const response = await axios.post(WHATSAPP_API_URL, {
      messaging_product: 'whatsapp',
      to: to,
      type: 'interactive',
      interactive: {
        type: 'button',
        body: { text: body },
        action: {
          buttons: buttons.map((button, index) => ({
            type: 'reply',
            reply: {
              id: `btn_${index}`,
              title: button
            }
          }))
        }
      }
    }, {
      headers: {
        'Authorization': `Bearer ${WHATSAPP_TOKEN}`,
        'Content-Type': 'application/json'
      }
    });
    return response.data;
  } catch (error) {
    console.error('Error sending interactive message:', error.response?.data || error.message);
    throw error;
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–ø–∏—Å–∫–∞ –æ–ø—Ü–∏–π
async function sendListMessage(to, body, sections) {
  try {
    const response = await axios.post(WHATSAPP_API_URL, {
      messaging_product: 'whatsapp',
      to: to,
      type: 'interactive',
      interactive: {
        type: 'list',
        body: { text: body },
        action: {
          button: '–í—ã–±—Ä–∞—Ç—å –≤–æ–ø—Ä–æ—Å',
          sections: sections
        }
      }
    }, {
      headers: {
        'Authorization': `Bearer ${WHATSAPP_TOKEN}`,
        'Content-Type': 'application/json'
      }
    });
    return response.data;
  } catch (error) {
    console.error('Error sending list message:', error.response?.data || error.message);
    throw error;
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
async function handleIncomingMessage(message) {
  const from = message.from;
  const messageType = message.type;
  
  if (messageType === 'text_message') {
    const text = message.text.body.toLowerCase();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userState = userStates.get(from) || { state: 'main' };
    
    if (text === '/start' || text === '–Ω–∞—á–∞—Ç—å' || text === '–º–µ–Ω—é') {
      userStates.set(from, { state: 'main' });
      await sendWelcomeMessage(from);
    } else if (userState.state === 'main') {
      await handleMainMenu(from, text);
    } else if (userState.state === 'question') {
      await handleQuestionResponse(from, text, userState.question);
    }
  } else if (messageType === 'interactive') {
    const interactive = message.interactive;
    
    if (interactive.type === 'button_reply') {
      await handleButtonClick(from, interactive.button_reply.id);
    } else if (interactive.type === 'list_reply') {
      await handleListSelection(from, interactive.list_reply.id);
    }
  }
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
async function sendWelcomeMessage(to) {
  const welcomeText = `üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç —Å–≤–∞–¥–µ–±–Ω—ã—Ö –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–π! üéâ

–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç—ã –Ω–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞—à–∏–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.

–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π –≤–∞—Å –≤–æ–ø—Ä–æ—Å:`;
  
  const sections = [
    {
      title: 'üé¨ –í–∏–¥–µ–æ-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è',
      rows: [
        { id: 'question_invitations_info', title: 'üìã –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è' },
        { id: 'question_invitations_price', title: 'üí∞ –¶–µ–Ω—ã –∏ —Å—Ä–æ–∫–∏' },
        { id: 'question_invitations_custom', title: '‚ùì –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑' }
      ]
    },
    {
      title: 'üíí –°–≤–∞–¥–µ–±–Ω–∞—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è',
      rows: [
        { id: 'question_presentations_info', title: 'üìã –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è' },
        { id: 'question_presentations_price', title: 'üí∞ –¶–µ–Ω—ã –∏ —Å—Ä–æ–∫–∏' },
        { id: 'question_presentations_custom', title: '‚ùì –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑' }
      ]
    },
    {
      title: '–°–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º',
      rows: [
        { id: 'consultation', title: 'üí¨ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º' }
      ]
    }
  ];
  
  await sendListMessage(to, welcomeText, sections);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
async function handleMainMenu(to, text) {
  const questionMap = {
    '–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è': 'question_invitations_info',
    '–≤–∏–¥–µ–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è': 'question_invitations_info',
    '–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è': 'question_presentations_info',
    '—Å–≤–∞–¥–µ–±–Ω–∞—è': 'question_presentations_info',
    '–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è': 'consultation',
    '–º–µ–Ω–µ–¥–∂–µ—Ä': 'consultation'
  };
  
  for (const [key, value] of Object.entries(questionMap)) {
    if (text.includes(key)) {
      await handleSelection(to, value);
      return;
    }
  }
  
  // –ï—Å–ª–∏ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª–∏, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
  await sendTextMessage(to, '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–∑ –º–µ–Ω—é –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ "–º–µ–Ω—é" –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ —Å–ø–∏—Å–∫—É –≤–æ–ø—Ä–æ—Å–æ–≤.');
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
async function handleSelection(to, selection) {
  if (selection.startsWith('question_')) {
    const questionKey = selection.replace('question_', '');
    const questionMap = {
      'invitations_info': '–í–∏–¥–µ–æ-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è ‚Äî –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
      'invitations_price': '–í–∏–¥–µ–æ-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è ‚Äî —Ü–µ–Ω—ã –∏ —Å—Ä–æ–∫–∏',
      'invitations_custom': '–ú–æ–∂–Ω–æ –ª–∏ –∑–∞–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ?',
      'presentations_info': '–°–≤–∞–¥–µ–±–Ω–∞—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è ‚Äî –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
      'presentations_price': '–°–≤–∞–¥–µ–±–Ω–∞—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è ‚Äî —Ü–µ–Ω—ã –∏ —Å—Ä–æ–∫–∏',
      'presentations_custom': '–ú–æ–∂–Ω–æ –ª–∏ –∑–∞–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—É—é –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é?'
    };
    
    const question = questionMap[questionKey];
    const questionData = quickQuestions[question];
    
    if (questionData) {
      userStates.set(to, { state: 'question', question: question });
      
      await sendTextMessage(to, questionData.answer);
      
      const buttons = [...questionData.quickActions, '–ù–∞–∑–∞–¥ –∫ –≤–æ–ø—Ä–æ—Å–∞–º'];
      await sendInteractiveMessage(to, '–ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –¥–∞–ª—å—à–µ?', buttons);
    }
  } else if (selection === 'consultation') {
    await sendConsultationMessage(to);
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫
async function handleButtonClick(to, buttonId) {
  if (buttonId === 'btn_0') {
    // –ü–µ—Ä–≤–∞—è –∫–Ω–æ–ø–∫–∞ (–ó–∞–∫–∞–∑–∞—Ç—å –∏–ª–∏ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è)
    const userState = userStates.get(to);
    if (userState && userState.state === 'question') {
      await sendOrderMessage(to);
    } else {
      await sendConsultationMessage(to);
    }
  } else if (buttonId === 'btn_1') {
    // –í—Ç–æ—Ä–∞—è –∫–Ω–æ–ø–∫–∞ (–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è)
    await sendConsultationMessage(to);
  } else if (buttonId === 'btn_2') {
    // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
    userStates.set(to, { state: 'main' });
    await sendWelcomeMessage(to);
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
async function handleListSelection(to, selectionId) {
  await handleSelection(to, selectionId);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å
async function handleQuestionResponse(to, text, question) {
  if (text.includes('–∑–∞–∫–∞–∑–∞—Ç—å') || text.includes('–∑–∞–∫–∞–∑')) {
    await sendOrderMessage(to);
  } else if (text.includes('–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è') || text.includes('–º–µ–Ω–µ–¥–∂–µ—Ä')) {
    await sendConsultationMessage(to);
  } else if (text.includes('–Ω–∞–∑–∞–¥') || text.includes('–º–µ–Ω—é')) {
    userStates.set(to, { state: 'main' });
    await sendWelcomeMessage(to);
  } else {
    await sendTextMessage(to, '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–æ–∫ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ "–Ω–∞–∑–∞–¥" –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –≤–æ–ø—Ä–æ—Å–∞–º.');
  }
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
async function sendConsultationMessage(to) {
  const consultationText = `üí¨ –î–ª—è —Å–≤—è–∑–∏ —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º:

üì± *WhatsApp:* +7 900 451-17-77
üì± *Telegram:* @svadba_manager
üìß *Email:* info@svadba-presentation.ru

‚è∞ *–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:* –ü–Ω-–ü—Ç 9:00-18:00

–ú–µ–Ω–µ–¥–∂–µ—Ä –æ—Ç–≤–µ—Ç–∏—Ç –≤–∞–º –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω—É—Ç –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è.`;
  
  await sendTextMessage(to, consultationText);
  
  const buttons = ['–ù–∞–∑–∞–¥ –∫ –≤–æ–ø—Ä–æ—Å–∞–º'];
  await sendInteractiveMessage(to, '–•–æ—Ç–∏—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤–æ–ø—Ä–æ—Å–∞–º?', buttons);
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –∑–∞–∫–∞–∑–µ
async function sendOrderMessage(to) {
  const orderText = `üõí –î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:

1Ô∏è‚É£ *–°–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º:*
   üì± WhatsApp: +7 900 451-17-77
   üì± Telegram: @svadba_manager

2Ô∏è‚É£ *–£–∫–∞–∂–∏—Ç–µ:*
   - –¢–∏–ø —É—Å–ª—É–≥–∏ (–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è/–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è)
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ/—Ä–∞–∑–≤–æ—Ä–æ—Ç–æ–≤
   - –ù—É–∂–Ω–æ –ª–∏ –æ–∂–∏–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ
   - –ñ–µ–ª–∞–µ–º—ã–µ —Å—Ä–æ–∫–∏

3Ô∏è‚É£ *–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞:* 30% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏

–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç –¥–ª—è –≤–∞—Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!`;
  
  await sendTextMessage(to, orderText);
  
  const buttons = ['–ù–∞–∑–∞–¥ –∫ –≤–æ–ø—Ä–æ—Å–∞–º'];
  await sendInteractiveMessage(to, '–•–æ—Ç–∏—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤–æ–ø—Ä–æ—Å–∞–º?', buttons);
}

// Webhook –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
async function handleWebhook(req, res) {
  try {
    const body = req.body;
    
    if (body.object === 'whatsapp_business_account') {
      const entry = body.entry[0];
      const changes = entry.changes[0];
      const value = changes.value;
      
      if (value.messages && value.messages.length > 0) {
        const message = value.messages[0];
        await handleIncomingMessage(message);
      }
      
      res.status(200).send('OK');
    } else {
      res.status(404).send('Not Found');
    }
  } catch (error) {
    console.error('Webhook error:', error);
    res.status(500).send('Internal Server Error');
  }
}

// –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è webhook
function verifyWebhook(req, res) {
  const mode = req.query['hub.mode'];
  const token = req.query['hub.verify_token'];
  const challenge = req.query['hub.challenge'];
  
  const verifyToken = process.env.WHATSAPP_VERIFY_TOKEN;
  
  if (mode && token) {
    if (mode === 'subscribe' && token === verifyToken) {
      console.log('Webhook verified');
      res.status(200).send(challenge);
    } else {
      res.status(403).send('Forbidden');
    }
  }
}

module.exports = {
  handleWebhook,
  verifyWebhook,
  sendTextMessage,
  sendInteractiveMessage,
  sendListMessage
};
