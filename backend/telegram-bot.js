const TelegramBot = require('node-telegram-bot-api');
require('dotenv').config();

// Ð¢Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð° Ð¸Ð· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
const token = process.env.TELEGRAM_BOT_TOKEN;

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ‚Ð¾ÐºÐµÐ½Ð°
if (!token) {
  console.error('âŒ TELEGRAM_BOT_TOKEN Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ!');
  console.error('Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ TELEGRAM_BOT_TOKEN Ð² .env Ñ„Ð°Ð¹Ð» Ð¸Ð»Ð¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Render');
  process.exit(1);
}

console.log('âœ… TELEGRAM_BOT_TOKEN Ð½Ð°Ð¹Ð´ÐµÐ½');
const bot = new TelegramBot(token, { polling: true }); // Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ polling Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾

// Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
const userStates = new Map();

// Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð² (Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸Ñ‡Ð½Ð¾ Ñ‡Ð°Ñ‚Ñƒ Ð½Ð° ÑÐ°Ð¹Ñ‚Ðµ)
const quickQuestions = {
  'Ð’Ð¸Ð´ÐµÐ¾-Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ñ â€” Ð¾Ð±Ñ‰Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ': {
    answer: `**ÐŸÑ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ðµ:** 
**ÐžÐ±Ñ‰Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ:**  
ÐŸÑ€Ð¸Ð³Ð»Ð°ÑÐ¸Ñ‚Ðµ ÑÐ²Ð¾Ð¸Ñ… Ð³Ð¾ÑÑ‚ÐµÐ¹ Ñ„ÐµÐµÑ€Ð¸Ñ‡Ð½Ð¾ Ð¸ ÑÐ¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ WOW-ÑÑ„Ñ„ÐµÐºÑ‚ ÐµÑ‰Ðµ Ð² ÑÐ°Ð¼Ð¾Ð¼ Ð½Ð°Ñ‡Ð°Ð»Ðµ!

ÐÐ°ÑˆÐ¸ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð²Ð¸Ð´ÐµÐ¾-Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ñ ÑƒÐ´Ð¸Ð²ÑÑ‚ Ð¸ Ð¿Ñ€Ð¾Ð¸Ð·Ð²ÐµÐ´ÑƒÑ‚ WOW
â€“ ÑÑ„Ñ„ÐµÐºÑ‚ Ð½Ð° Ð²Ð°ÑˆÐ¸Ñ… Ð³Ð¾ÑÑ‚ÐµÐ¹. ÐžÐ½Ð¸ Ð·Ð°Ð¿Ð¾Ð¼Ð½ÑÑ‚ Ð²Ð°ÑˆÑƒ ÑÐ²Ð°Ð´ÑŒÐ±Ñƒ ÐµÑ‰Ðµ Ñ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ñ Ð¸ Ñ‚Ð¾Ñ‡Ð½Ð¾Ð·Ð°Ñ…Ð¾Ñ‚ÑÑ‚ Ð½Ð° Ð½ÐµÐµ Ð¿Ñ€Ð¸Ð¹Ñ‚Ð¸.

Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ðµ, Ð¾Ð´Ð¸Ð½Ð°ÐºÐ¾Ð²Ð¾Ðµ Ð´Ð»Ñ Ð²ÑÐµÑ…,Ð±ÐµÐ· Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ñ, ÐºÐ°Ðº Ð² ÑˆÐ°Ð±Ð»Ð¾Ð½Ðµ. Ð Ð¼Ð¾Ð¶Ð½Ð¾ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ Ð¸Ð¼ÐµÐ½Ð½Ð¾Ðµ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ðµ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾
Ð³Ð¾ÑÑ‚Ñ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾.`,
    quickActions: ['Ð—Ð°ÐºÐ°Ð·Ð°Ñ‚ÑŒ', 'ÐšÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ñ']
  },
  'Ð’Ð¸Ð´ÐµÐ¾-Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ñ â€” Ñ†ÐµÐ½Ñ‹ Ð¸ ÑÑ€Ð¾ÐºÐ¸': {
    answer: `**Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¸ ÑÑ€Ð¾ÐºÐ¸:** 
**ÐÐµÐ¸Ð¼ÐµÐ½Ð½Ð¾Ðµ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ðµ:** 
Ð—Ð°Ð¼ÐµÐ½Ð° Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ð¸ Ð±ÐµÐ· Ð¸Ð¼ÐµÐ½Ð¸ â€“ 3000 Ñ€./ ÑÑ€Ð¾Ðº â€“1 Ð´ÐµÐ½ÑŒ
 **Ð˜Ð¼ÐµÐ½Ð½Ð¾Ðµ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ðµ:**  
Ð¡ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸ÐµÐ¼ Ð¸ ÑƒÐºÐ°Ð·Ð°Ð½Ð¸ÐµÐ¼ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¸Ð¼ÐµÐ½Ð¸ Ð²Ð½Ð°Ñ‡Ð°Ð»Ðµ: 
Ð´Ð¾ 25 Ð¸Ð¼ÐµÐ½ â€“ 4000 Ñ€, 
Ð´Ð¾ 50 Ð¸Ð¼ÐµÐ½ â€“ 5000 Ñ€, 
 51-100 Ð¸Ð¼ÐµÐ½ â€“ 7000 Ñ€ 
Ð¡Ñ€Ð¾Ðº Ð¸ÑÐ¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ 2-4 Ð´Ð½Ñ, Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ Ð¿Ð¾ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸.`,
    quickActions: ['Ð—Ð°ÐºÐ°Ð·Ð°Ñ‚ÑŒ', 'ÐšÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ñ']
  },
  'ÐœÐ¾Ð¶Ð½Ð¾ Ð»Ð¸ Ð·Ð°ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¸Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ðµ?': {
    answer: `ÐžÐ¿Ð¸ÑˆÐ¸Ñ‚Ðµ ÐºÐ°Ðº Ð²Ð¸Ð´Ð¸Ñ‚Ðµ Ð¸ Ð¼Ñ‹ ÑÐºÐ°Ð¶ÐµÐ¼ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ Ð»Ð¸ ÑÑ‚Ð¾.`,
    quickActions: ['Ð—Ð°ÐºÐ°Ð·Ð°Ñ‚ÑŒ', 'ÐšÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ñ']
  },
  'Ð¡Ð²Ð°Ð´ÐµÐ±Ð½Ð°Ñ Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ â€” Ð¾Ð±Ñ‰Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ': {
    answer: `**ÐžÐ±Ñ‰Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ:** 

1. Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð´Ð¾ Ð·Ð°ÐºÐ°Ð·Ð° Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒÑÑ Ñ ÑÐºÑ€Ð°Ð½Ð¾Ð¼, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ñ…Ð¾Ñ‚Ð¸Ñ‚ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð´Ð»Ñ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸. Ð”Ð»Ñ Ð¿Ð¾ÐºÐ°Ð·Ð° Ð¿Ð¾Ð´Ð¾Ð¹Ð´ÑƒÑ‚ Ð½Ðµ Ð²ÑÐµ ÑÐºÑ€Ð°Ð½Ñ‹, Ð° Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ
Ð¿Ñ€Ð¾Ð¿Ð¾Ñ€Ñ†Ð¸ÑÐ¼Ð¸ 16:9 Ð¸ 16:10. Ð£Ñ‚Ð¾Ñ‡Ð½Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾Ð¿Ð¾Ñ€Ñ†Ð¸Ð¸ Ñƒ Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†Ð° ÑÐºÑ€Ð°Ð½Ð°, Ð° Ñ‚Ð°ÐºÐ¶Ðµ ÐµÐ³Ð¾Ñ€Ð°Ð·Ð¼ÐµÑ€, Ð¸ ÑÐ¾Ð¾Ð±Ñ‰Ð¸Ñ‚Ðµ Ð½Ð°Ð¼ Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°ÐºÐ°Ð·Ð¾Ð¼. Ð§Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ ÐºÐ°Ðº Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð½Ð¾ Ð±ÑƒÐ´ÐµÑ‚
Ð²Ñ‹Ð³Ð»ÑÐ´ÐµÑ‚ÑŒ Ð²Ð°ÑˆÐµ Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð½Ð° ÑÑ‚Ð¾Ð¼ ÑÐºÑ€Ð°Ð½Ðµ â€“ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ ÑÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð½Ð°Ñˆ Ð¾Ð±Ñ€Ð°Ð·ÐµÑ† Ð¸Ð¿Ð¾Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ ÐµÐµ Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð½Ð° Ð½Ñ‘Ð¼. 

2. Ð”Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð²Ð¸Ð´ÐµÐ¾ Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° Ñ„Ð¾Ñ‚Ð¾ Ð¸ Ñ€Ð°Ð·Ð²Ð¾Ñ€Ð¾Ñ‚Ð¾Ð² Ð°Ð»ÑŒÐ±Ð¾Ð¼Ð°. Ð’Ð½Ð°ÑˆÐµÐ¼ Ð²Ð¸Ð´ÐµÐ¾-Ð¾Ð±Ñ€Ð°Ð·Ñ†Ðµ 16 Ñ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ð¹ Ð¸ 4 Ñ€Ð°Ð·Ð²Ð¾Ñ€Ð¾Ñ‚Ð°. Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð²
Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ€Ð°Ð·Ð²Ð¾Ñ€Ð¾Ñ‚Ñ‹ (ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ€Ð°Ð·Ð²Ð¾Ñ€Ð¾Ñ‚ â€“ 4 Ñ„Ð¾Ñ‚Ð¾). Ð¦ÐµÐ½Ð° ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð²Ð¾Ñ€Ð¾Ñ‚Ð° + 500 - 1000 Ñ€ÑƒÐ±. Ð¢Ð°ÐºÐ¶Ðµ Ð´Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð²Ð¸Ð´ÐµÐ¾ Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚
Ð¾Ð±ÑŠÐµÐ¼Ð° Ñ‚ÐµÐºÑÑ‚Ð° Ð² Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ð¸ Ñ„Ð¾Ñ‚Ð¾. Ð’ ÑˆÐ°Ð±Ð»Ð¾Ð½Ðµ Ð² Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ð¸ Ðº Ñ„Ð¾Ñ‚Ð¾ Ð½Ðµ Ð±Ð¾Ð»ÑŒÑˆÐµ 300ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð². Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÐ¼ Ð¾ÑÑ‚Ð°Ð²Ð»ÑÑ‚ÑŒ Ñ‚Ð°ÐºÐ¶Ðµ, Ð½Ðµ Ð´ÐµÐ»Ð°Ñ‚ÑŒ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ðº Ð¾Ð´Ð½Ð¾Ð¼Ñƒ Ñ„Ð¾Ñ‚Ð¾ Ð±Ð¾Ð»ÑŒÑˆÐµ.
Ð­Ñ‚Ð¾ Ð±ÑƒÐ´ÐµÑ‚ Ð²Ñ‹Ð³Ð»ÑÐ´ÐµÑ‚ÑŒ Ð·Ð°Ñ‚ÑÐ½ÑƒÑ‚Ð¾ Ð¸ Ð·Ð°Ð½ÑƒÐ´Ð½Ð¾.. Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ. Ð§Ñ‚Ð¾Ð±Ñ‹ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ(Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ Ð±Ð¸Ð¾Ð³Ñ€Ð°Ñ„Ð¸ÑŽ Ð¼Ð°Ð¼Ñ‹) Ð±Ð¾Ð»ÑŒÑˆÐµ - Ð»ÑƒÑ‡ÑˆÐµ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÑ‚ÑŒ Ñ„Ð¾Ñ‚Ð¾ Ð¸ Ñ€Ð°Ð·Ð²Ð¾Ñ€Ð¾Ñ‚Ñ‹.. Ð‘ÑƒÐ´ÐµÑ‚
Ð²Ñ‹Ð³Ð»ÑÐ´ÐµÑ‚ÑŒ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ð¾! 
3. Ð’ ÑˆÐ°Ð±Ð»Ð¾Ð½Ðµ Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸ Ð²ÑÐµ Ñ„Ð¾Ñ‚Ð¾ Â«Ð¾Ð¶Ð¸Ð²Ð»ÐµÐ½Ñ‹Â». ÐœÐ¾Ð¶Ð½Ð¾ Ð·Ð°ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ Ð¸Ð±ÐµÐ· Ð¾Ð¶Ð¸Ð²Ð»ÐµÐ½Ð¸Ñ. ÐžÐ¶Ð¸Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð¾Ð¸Ñ‚ + 2000 (16 Ñ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ð¹). Ð˜ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÑ‚ Ðº ÑÑ€Ð¾ÐºÑƒ
Ð¸Ð·Ð³Ð¾Ñ‚Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ 1-2 Ð´Ð½Ñ. 
4. ÐŸÐ¾ÐºÐ° Ð¼ÑƒÐ·Ñ‹ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸ Ñ‚Ð¾Ð¶Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² Ð¾Ð´Ð½Ð¾Ð¼Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ðµ. Ð’ Ð´Ð°Ð»ÑŒÐ½ÐµÐ¹ÑˆÐµÐ¼ Ð±ÑƒÐ´ÑƒÑ‚ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð°ÑƒÐ´Ð¸Ð¾-Ð¿Ð¾Ð´Ð»Ð¾Ð¶ÐºÐ¸ Ð½Ð° Ð²Ñ‹Ð±Ð¾Ñ€. 
5. ÐŸÐ¾ÑÐ»Ðµ Ñ‚Ð¾Ð³Ð¾ ÐºÐ°Ðº Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÐµÑÑŒ Ñ ÑÐºÑ€Ð°Ð½Ð¾Ð¼, Ð´Ð»Ñ Ð·Ð°ÐºÐ°Ð·Ð° Ñ‡ÐµÑ€ÐµÐ· Ñ„Ð¾Ñ€Ð¼Ñƒ
Â«Ð·Ð°ÐºÐ°Ð·Ð°Ñ‚ÑŒÂ», Ð½ÑƒÐ¶Ð½Ð¾ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ Ð¿Ñ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ñƒ Ð² Ñ€Ð°Ð·Ð¼ÐµÑ€Ðµ 30% (Ð² ÑÐ»ÑƒÑ‡Ð°Ðµ Ð¾Ñ‚ÐºÐ°Ð·Ð° Ð¾Ñ‚ Ð·Ð°ÐºÐ°Ð·Ð°Ð¿Ñ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ð° Ð½Ðµ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ÑÑ). ÐŸÐ¾ÑÐ»Ðµ Ñ‡ÐµÐ³Ð¾ Ð²Ð°Ð¼ Ð±ÑƒÐ´ÐµÑ‚ Ð²Ñ‹ÑÐ»Ð°Ð½Ð° Ñ„Ð¾Ñ€Ð¼Ð° Ð´Ð»Ñ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ
Ñ„Ð¾Ñ‚Ð¾ Ð¸ Ñ‚ÐµÐºÑÑ‚Ð°. ÐžÑ‡ÐµÐ½ÑŒ Ñ‚Ñ‰Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¿Ð¾Ð´Ð¾Ð¹Ð´Ð¸Ñ‚Ðµ Ðº Ð¿Ð¾Ð´Ð±Ð¾Ñ€Ñƒ Ñ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ð¹. Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð²Ð°ÑˆÐ¸Ð»ÑŽÐ±Ð¸Ð¼Ñ‹Ðµ Ñ„Ð¾Ñ‚Ð¾ Ð¸Ð· Ð²Ð°ÑˆÐµÐ³Ð¾ Ð´ÐµÑ‚ÑÑ‚Ð²Ð°, ÑˆÐºÐ¾Ð»ÑŒÐ½Ñ‹Ñ… Ð»ÐµÑ‚, ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‡ÐµÑÑ‚Ð²Ð° Ð¸ ÐºÐ¾Ð½ÐµÑ‡Ð½Ð¾ Ð¶Ðµ Ð²Ð°ÑˆÐ¸
Ð»ÑƒÑ‡ÑˆÐ¸Ðµ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð½Ñ‹Ðµ Ñ„Ð¾Ñ‚Ð¾. Ð¿Ð¾ÑÐ»Ðµ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð° Ð¼Ñ‹ Ð²Ñ‹ÑˆÐ»ÐµÐ¼ Ð²Ð°Ð¼ Ñ„Ð¾Ñ€Ð¼Ñƒ Ð´Ð»ÑÐ·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ñ„Ð¾Ñ‚Ð¾ Ð¸ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ. Ð·Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ñ‚ÑƒÐ´Ð° Ð²ÑÐµ Ñ„Ð¾Ñ‚Ð¾ Ð¸ Ñ‚ÐµÐºÑÑ‚. ÐŸÐ¾ÑÐ»Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ
Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ð¾Ð² Ð¼Ñ‹ Ð¿Ñ€Ð¸ÑÑ‚ÑƒÐ¿Ð°ÐµÐ¼ Ðº Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´ÑÑ‚Ð²Ñƒ. ÐŸÐ¾ÑÐ»Ðµ Ð¾ÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ñ Ð¼Ñ‹ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ð²Ð°Ð¼Ð²Ð¸Ð´ÐµÐ¾ Ð½Ð° ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ð¸Ðµ. Ð”Ð¾Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ 1 Ð¿Ñ€Ð°Ð²ÐºÐ° Ð² Ñ‚ÐµÐºÑÑ‚Ðµ. Ð¢Ð°Ðº Ñ‡Ñ‚Ð¾ Ñ„Ð¾Ñ‚Ð¾
Ð¿Ð¾Ð´Ð±Ð¸Ñ€Ð°Ð¹Ñ‚Ðµ Ð¾Ñ‡ÐµÐ½ÑŒ Ð¾Ð±Ð´ÑƒÐ¼Ð°Ð½Ð½Ð¾. ÐŸÐ¾ÑÐ»Ðµ Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð¸ Ð¾ÐºÐ¾Ð½Ñ‡Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ð¸Ñ Ð²Ð°ÑˆÐµÐ¹Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸ Ð²Ð°Ð¼ Ð½ÑƒÐ¶Ð½Ð¾ Ð´Ð¾Ð¿Ð»Ð°Ñ‚Ð¸Ñ‚ÑŒ 70 % ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¸ Ð¼Ñ‹ Ð¿Ñ€Ð¸ÑˆÐ»ÐµÐ¼ Ð²Ð°Ð¼ Ð²Ð°ÑˆÑƒ ÑÐ²Ð°Ð´ÐµÐ±Ð½ÑƒÑŽ
Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ Ð½Ð° Ð¿Ð¾Ñ‡Ñ‚Ñƒ.`,
    quickActions: ['Ð—Ð°ÐºÐ°Ð·Ð°Ñ‚ÑŒ', 'ÐšÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ñ']
  },
  'Ð¡Ð²Ð°Ð´ÐµÐ±Ð½Ð°Ñ Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ â€” Ñ†ÐµÐ½Ñ‹ Ð¸ ÑÑ€Ð¾ÐºÐ¸': {
    answer: `**Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¸ ÑÑ€Ð¾ÐºÐ¸:** 
**ÐŸÑ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð±ÐµÐ· Ð¾Ð¶Ð¸Ð²Ð»ÐµÐ½Ð¸Ñ Ñ„Ð¾Ñ‚Ð¾** (Ñ„Ð¾Ñ‚Ð¾ Ð±ÐµÐ· Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ñ) Ð¸  Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸ÐµÐ¼ Ðº ÐºÐ°Ð¶Ð´Ð¾Ð¼Ñƒ Ñ„Ð¾Ñ‚Ð¾ Ð½Ð° 300 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð² (ÐºÐ°ÐºÐ² ÑˆÐ°Ð±Ð»Ð¾Ð½Ðµ):
4 Ñ€Ð°Ð·Ð²Ð¾Ñ€Ð¾Ñ‚Ð° (16 Ñ„Ð¾Ñ‚Ð¾, 6:23 Ð¼Ð¸Ð½) â€“ 10000Ñ€ / ÑÑ€Ð¾Ðº 3-4 Ð´Ð½Ñ
5 Ñ€Ð°Ð·Ð²Ð¾Ñ€Ð¾Ñ‚Ð¾Ð² (20 Ñ„Ð¾Ñ‚Ð¾, 8 Ð¼Ð¸Ð½) â€“ 10500/ÑÑ€Ð¾Ðº 3-4  Ð´Ð½Ñ 
6 Ñ€Ð°Ð·Ð²Ð¾Ñ€Ð¾Ñ‚Ð¾Ð² (24 Ñ„Ð¾Ñ‚Ð¾, 10 Ð¼Ð¸Ð½) â€“ 11000 / ÑÑ€Ð¾Ðº 4-5 Ð´Ð½ÐµÐ¹ 
7 Ñ€Ð°Ð·Ð²Ð¾Ñ€Ð¾Ñ‚Ð¾Ð² (28 Ñ„Ð¾Ñ‚Ð¾, 12 Ð¼Ð¸Ð½) â€“ 11500 / ÑÑ€Ð¾Ðº 4-5 Ð´Ð½ÐµÐ¹
**Ð¦ÐµÐ½Ñ‹ Ñ Ð¾Ð¶Ð¸Ð²Ð»ÐµÐ½Ð¸ÐµÐ¼ Ñ„Ð¾Ñ‚Ð¾** Ð¸ Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼ Ð² Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ð¸ Ðº ÐºÐ°Ð¶Ð´Ð¾Ð¼Ñƒ Ñ„Ð¾Ñ‚Ð¾ 300
ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð² (ÐºÐ°Ðº ÑˆÐ°Ð±Ð»Ð¾Ð½):
 4 Ñ€Ð°Ð·Ð²Ð¾Ñ€Ð¾Ñ‚Ð° (16 Ñ„Ð¾Ñ‚Ð¾,6:23 Ð¼Ð¸Ð½) â€“ 12000Ñ€ /ÑÑ€Ð¾Ðº 4-5 Ð´Ð½ÐµÐ¹
5 Ñ€Ð°Ð·Ð²Ð¾Ñ€Ð¾Ñ‚Ð¾Ð² (20 Ñ„Ð¾Ñ‚Ð¾, 8 Ð¼Ð¸Ð½) â€“ 1300/ÑÑ€Ð¾Ðº 4-5  Ð´Ð½ÐµÐ¹ 
6 Ñ€Ð°Ð·Ð²Ð¾Ñ€Ð¾Ñ‚Ð¾Ð² (24 Ñ„Ð¾Ñ‚Ð¾, 10 Ð¼Ð¸Ð½) â€“ 13500 / ÑÑ€Ð¾Ðº 5-6 Ð´Ð½ÐµÐ¹ 
7 Ñ€Ð°Ð·Ð²Ð¾Ñ€Ð¾Ñ‚Ð¾Ð² (28 Ñ„Ð¾Ñ‚Ð¾, 12 Ð¼Ð¸Ð½) â€“ 14000 / ÑÑ€Ð¾Ðº 5-6 Ð´Ð½ÐµÐ¹
Ð—Ð° ÐºÐ°Ð¶Ð´Ñ‹Ðµ 300+ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð² Ðº Ñ‚ÐµÐºÑÑ‚Ñƒ Ð´Ð»Ñ Ñ„Ð¾Ñ‚Ð¾ - 200Ñ€ (Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ñ:
Ð¾ÑÑ‚Ð°Ð²Ð»ÑÑ‚ÑŒ Ñ‚ÐµÐºÑÑ‚ Ð½Ð° 300 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð² Ð¿Ð¾Ð´ ÐºÐ°Ð¶Ð´Ð¾Ðµ Ñ„Ð¾Ñ‚Ð¾, Ð¸Ð½Ð°Ñ‡Ðµ Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒÑÑÐ·Ð°Ð½ÑƒÐ´Ð½Ð¾. Ð•ÑÐ»Ð¸ Ñ…Ð¾Ñ‡ÐµÑ‚ÑÑ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ â€” Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹Ñ‚Ðµ Ð»ÑƒÑ‡ÑˆÐµ Ñ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ð¸ Ð¸ Ñ€Ð°Ð·Ð²Ð¾Ñ€Ð¾Ñ‚Ñ‹,
Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒÑÑ Ð½Ð°Ð¼Ð½Ð¾Ð³Ð¾ Ð»ÑƒÑ‡ÑˆÐµ)
Ð¡Ñ€Ð¾ÐºÐ¸ Ð¼Ð¾Ð³ÑƒÑ‚ Ð²Ð°Ñ€ÑŒÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒÑÑ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ð¸ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹. Ð£Ð²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°Ñ‚ÑŒÑÑ  Ð¿Ð¾
ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ð¸ÑŽ Ñ Ð·Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÐ¾Ð¼.`,
    quickActions: ['Ð—Ð°ÐºÐ°Ð·Ð°Ñ‚ÑŒ', 'ÐšÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ñ']
  },
  'ÐœÐ¾Ð¶Ð½Ð¾ Ð»Ð¸ Ð·Ð°ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¸Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½ÑƒÑŽ Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ?': {
    answer: `Ð’ Ð¿Ñ€Ð¸Ð½Ñ†Ð¸Ð¿Ðµ Ð¼Ð¾Ð¶Ð½Ð¾. ÐžÐ¿Ð¸ÑˆÐ¸Ñ‚Ðµ ÐºÐ°Ðº Ð²Ñ‹ ÐµÐµ Ð²Ð¸Ð´Ð¸Ñ‚Ðµ. Ð˜ Ð¼Ñ‹ ÑÐºÐ°Ð¶ÐµÐ¼ ÑÐ¼Ð¾Ð¶ÐµÐ¼ Ð»Ð¸ Ð¼Ñ‹ ÑÑ‚Ð¾.`,
    quickActions: ['Ð—Ð°ÐºÐ°Ð·Ð°Ñ‚ÑŒ', 'ÐšÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ñ']
  }
};

// Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ
const mainMenu = {
  reply_markup: {
    inline_keyboard: [
      [{ text: 'ðŸŽ¬ Ð’Ð¸Ð´ÐµÐ¾-Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ñ', callback_data: 'category_invitations' }],
      [{ text: 'ðŸ’’ Ð¡Ð²Ð°Ð´ÐµÐ±Ð½Ð°Ñ Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ', callback_data: 'category_presentations' }],
      [{ text: 'ðŸ’¬ ÐšÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ñ Ñ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ð¾Ð¼', callback_data: 'consultation' }]
    ]
  }
};

// Ð’ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¾Ð´Ð½Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
async function showMainMenu(chatId, messageId) {
  const text = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÑƒÑŽÑ‰Ð¸Ð¹ Ð²Ð°Ñ Ð²Ð¾Ð¿Ñ€Ð¾Ñ:';
  try {
    await bot.editMessageText(text, {
      chat_id: chatId,
      message_id: messageId,
      reply_markup: mainMenu.reply_markup,
      parse_mode: 'Markdown'
    });
  } catch (err) {
    // Ð•ÑÐ»Ð¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð½ÐµÐ»ÑŒÐ·Ñ Ð¾Ñ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð¿ÐµÑ€Ð²Ð¾Ðµ Ð¿Ð¾ÑÐ»Ðµ /start), Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ð¼ Ð½Ð¾Ð²Ð¾Ðµ
    await bot.sendMessage(chatId, text, { reply_markup: mainMenu.reply_markup });
  }
}

function buildCategoryMenu(category) {
  if (category === 'invitations') {
    return {
      text: 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÑƒÑŽÑ‰Ð¸Ð¹ Ð²Ð°Ñ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¾ Ð²Ð¸Ð´ÐµÐ¾-Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸ÑÑ…:',
      markup: {
        inline_keyboard: [
          [{ text: 'ðŸ“‹ ÐžÐ±Ñ‰Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ', callback_data: 'question_invitations_info' }],
          [{ text: 'ðŸ’° Ð¦ÐµÐ½Ñ‹ Ð¸ ÑÑ€Ð¾ÐºÐ¸', callback_data: 'question_invitations_price' }],
          [{ text: 'â“ Ð˜Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð·Ð°ÐºÐ°Ð·', callback_data: 'question_invitations_custom' }],
          [{ text: 'â¬…ï¸ ÐÐ°Ð·Ð°Ð´ Ð² Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ', callback_data: 'back_to_main' }]
        ]
      }
    };
  }
  return {
    text: 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÑƒÑŽÑ‰Ð¸Ð¹ Ð²Ð°Ñ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¾ ÑÐ²Ð°Ð´ÐµÐ±Ð½Ð¾Ð¹ Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸:',
    markup: {
      inline_keyboard: [
        [{ text: 'ðŸ“‹ ÐžÐ±Ñ‰Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ', callback_data: 'question_presentations_info' }],
        [{ text: 'ðŸ’° Ð¦ÐµÐ½Ñ‹ Ð¸ ÑÑ€Ð¾ÐºÐ¸', callback_data: 'question_presentations_price' }],
        [{ text: 'â“ Ð˜Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð·Ð°ÐºÐ°Ð·', callback_data: 'question_presentations_custom' }],
        [{ text: 'â¬…ï¸ ÐÐ°Ð·Ð°Ð´ Ð² Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ', callback_data: 'back_to_main' }]
      ]
    }
  };
}

async function showCategoryMenu(chatId, messageId, category) {
  const { text, markup } = buildCategoryMenu(category);
  try {
    await bot.editMessageText(text, {
      chat_id: chatId,
      message_id: messageId,
      reply_markup: markup,
      parse_mode: 'Markdown'
    });
  } catch (err) {
    await bot.sendMessage(chatId, text, { reply_markup: markup });
  }
}

const questionKeyToTitle = {
  'invitations_info': 'Ð’Ð¸Ð´ÐµÐ¾-Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ñ â€” Ð¾Ð±Ñ‰Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ',
  'invitations_price': 'Ð’Ð¸Ð´ÐµÐ¾-Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ñ â€” Ñ†ÐµÐ½Ñ‹ Ð¸ ÑÑ€Ð¾ÐºÐ¸',
  'invitations_custom': 'ÐœÐ¾Ð¶Ð½Ð¾ Ð»Ð¸ Ð·Ð°ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¸Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ðµ?',
  'presentations_info': 'Ð¡Ð²Ð°Ð´ÐµÐ±Ð½Ð°Ñ Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ â€” Ð¾Ð±Ñ‰Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ',
  'presentations_price': 'Ð¡Ð²Ð°Ð´ÐµÐ±Ð½Ð°Ñ Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ â€” Ñ†ÐµÐ½Ñ‹ Ð¸ ÑÑ€Ð¾ÐºÐ¸',
  'presentations_custom': 'ÐœÐ¾Ð¶Ð½Ð¾ Ð»Ð¸ Ð·Ð°ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¸Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½ÑƒÑŽ Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ?'
};

async function showQuestion(chatId, messageId, category, questionKey) {
  const title = questionKeyToTitle[`${category}_${questionKey}`];
  const questionData = quickQuestions[title];
  if (!questionData) return;

  const quickActionsRow = [
    { text: 'ðŸ›’ Ð—Ð°ÐºÐ°Ð·Ð°Ñ‚ÑŒ', callback_data: 'order' },
    { text: 'ðŸ’¬ ÐšÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ñ', callback_data: 'consultation' }
  ];

  const keyboard = {
    inline_keyboard: [
      quickActionsRow,
      [{ text: 'â¬…ï¸ ÐÐ°Ð·Ð°Ð´ Ðº Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°Ð¼', callback_data: `back_to_category_${category}` }],
      [{ text: 'ðŸ  Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ', callback_data: 'back_to_main' }]
    ]
  };

  try {
    await bot.editMessageText(questionData.answer, {
      chat_id: chatId,
      message_id: messageId,
      reply_markup: keyboard,
      parse_mode: 'Markdown'
    });
  } catch (err) {
    await bot.sendMessage(chatId, questionData.answer, { reply_markup: keyboard, parse_mode: 'Markdown' });
  }
}

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
bot.onText(/\/start/, (msg) => {
  console.log('ðŸŽ¯ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð° ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° /start Ð¾Ñ‚:', msg.from.first_name, 'ID:', msg.chat.id);
  
  const chatId = msg.chat.id;
  const userName = msg.from.first_name;
  
  userStates.set(chatId, { state: 'main' });
  
  const welcomeMessage = `ðŸ‘‹ ÐŸÑ€Ð¸Ð²ÐµÑ‚, ${userName}!

Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ð±Ð¾Ñ‚ ÑÐ²Ð°Ð´ÐµÐ±Ð½Ñ‹Ñ… Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¹! ðŸŽ‰

Ð—Ð´ÐµÑÑŒ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹ Ð½Ð° Ð¿Ð¾Ð¿ÑƒÐ»ÑÑ€Ð½Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¸Ð»Ð¸ ÑÐ²ÑÐ·Ð°Ñ‚ÑŒÑÑ Ñ Ð½Ð°ÑˆÐ¸Ð¼ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ð¾Ð¼ Ð´Ð»Ñ ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ð¸.

Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÑƒÑŽÑ‰Ð¸Ð¹ Ð²Ð°Ñ Ð²Ð¾Ð¿Ñ€Ð¾Ñ:`;
  
  bot.sendMessage(chatId, welcomeMessage, mainMenu)
    .then(() => console.log('âœ… ÐŸÑ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾'))
    .catch(err => console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:', err));
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° callback Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
bot.on('callback_query', async (query) => {
  console.log('ðŸ”˜ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ callback Ð¾Ñ‚:', query.from.first_name, 'Ð”Ð°Ð½Ð½Ñ‹Ðµ:', query.data);
  
  const chatId = query.message.chat.id;
  const data = query.data;
  const messageId = query.message.message_id;
  
  // ÐžÑ‚Ð²ÐµÑ‡Ð°ÐµÐ¼ Ð½Ð° callback
  await bot.answerCallbackQuery(query.id);
  
  if (data.startsWith('category_')) {
    const category = data.replace('category_', '');
    userStates.set(chatId, { state: 'category', category });
    await showCategoryMenu(chatId, messageId, category);
  } else if (data.startsWith('question_')) {
    const parts = data.split('_'); // ['question', '<category>', '<key>']
    const category = parts[1];
    const key = parts[2];
    await showQuestion(chatId, messageId, category, key);
  } else if (data === 'consultation') {
    const text = `ðŸ’¬ Ð”Ð»Ñ ÑÐ²ÑÐ·Ð¸ Ñ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ð¾Ð¼:\n\nÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð½Ð°Ð¼ Ð² Ð¼ÐµÑÑÐµÐ½Ð´Ð¶ÐµÑ€ Ð¸ Ð¼Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ð¼ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ð±Ñ‹ÑÑ‚Ñ€Ð¾.`;
    const keyboard = {
      inline_keyboard: [
        [
          { text: 'ðŸ“² ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Telegram', url: 'https://t.me/feyero_bot?start=consultation' },
          { text: 'ðŸ“² ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ WhatsApp', url: 'https://wa.me/79004511777' }
        ],
        [{ text: 'â¬…ï¸ ÐÐ°Ð·Ð°Ð´', callback_data: 'back_to_main' }]
      ]
    };
    await bot.editMessageText(text, { chat_id: chatId, message_id: messageId, reply_markup: keyboard });
  } else if (data === 'order') {
    const text = `ðŸ›’ Ð”Ð»Ñ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð°:\n\n1ï¸âƒ£ Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¼ÐµÑÑÐµÐ½Ð´Ð¶ÐµÑ€ Ð¸ Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð½Ð°Ð¼.\n2ï¸âƒ£ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ: Ñ‚Ð¸Ð¿ ÑƒÑÐ»ÑƒÐ³Ð¸, Ð¾Ð±ÑŠÑ‘Ð¼ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ð¾Ð² Ð¸ ÑÑ€Ð¾ÐºÐ¸.`;
    const keyboard = {
      inline_keyboard: [
        [
          { text: 'ðŸ“² ÐÐ°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð² Telegram', url: 'https://t.me/feyero_bot?start=order' },
          { text: 'ðŸ“² ÐÐ°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð² WhatsApp', url: 'https://wa.me/79004511777' }
        ],
        [{ text: 'â¬…ï¸ ÐÐ°Ð·Ð°Ð´', callback_data: 'back_to_main' }]
      ]
    };
    await bot.editMessageText(text, { chat_id: chatId, message_id: messageId, reply_markup: keyboard });
  } else if (data.startsWith('back_to_category_')) {
    const category = data.replace('back_to_category_', '');
    await showCategoryMenu(chatId, messageId, category);
  } else if (data === 'back_to_main') {
    userStates.set(chatId, { state: 'main' });
    await showMainMenu(chatId, messageId);
  }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
bot.on('message', (msg) => {
  console.log('ðŸ“¨ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚:', msg.from.first_name, 'Ð¢ÐµÐºÑÑ‚:', msg.text);
  
  const chatId = msg.chat.id;
  
  // Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ Ð½Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° /start, Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°ÐµÐ¼ Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒÑÑ Ðº Ð¼ÐµÐ½ÑŽ
  if (!msg.text.startsWith('/')) {
    const helpMessage = `Ð”Ð»Ñ Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð¼ÐµÐ½ÑŽ Ð¸Ð»Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ /start Ð´Ð»Ñ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚Ð° Ðº Ð³Ð»Ð°Ð²Ð½Ð¾Ð¼Ñƒ Ð¼ÐµÐ½ÑŽ.`;
    
    const helpKeyboard = {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'ðŸ  Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ', callback_data: 'back_to_main' }]
        ]
      }
    };
    
    bot.sendMessage(chatId, helpMessage, helpKeyboard)
      .then(() => console.log('âœ… ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð°'))
      .catch(err => console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð¸:', err));
  }
});



console.log('Telegram bot started...');

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ polling Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»ÑÑ
bot.on('polling_error', (error) => {
  console.error('âŒ Polling error:', error);
  
  // Ð•ÑÐ»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ° 409 (ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚), Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ polling Ñ‡ÐµÑ€ÐµÐ· 5 ÑÐµÐºÑƒÐ½Ð´
  if (error.code === 'ETELEGRAM' && error.response && error.response.statusCode === 409) {
    console.log('ðŸ”„ Bot conflict detected, restarting polling in 5 seconds...');
    setTimeout(() => {
      bot.stopPolling().then(() => {
        setTimeout(() => {
          bot.startPolling();
          console.log('âœ… Bot polling restarted');
        }, 1000);
      });
    }, 5000);
  }
});

bot.on('error', (error) => {
  console.error('âŒ Bot error:', error);
});

// Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
setTimeout(() => {
  console.log('âœ… Telegram bot polling Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½ Ð¸ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ');
}, 2000);

module.exports = bot;
